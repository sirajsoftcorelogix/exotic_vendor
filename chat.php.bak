<?php
require_once 'bootstrap/init/init.php';
require_once("helpers/html_helpers.php");
is_login();
$currentUserId = $_SESSION["user"]['id'] ?? null;
$apiToken = fetchAPIToken($currentUserId);
if (!$currentUserId) {
    die('You must be logged In');
}
?>
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Internal Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="assets/chat.css">
</head>
<body>
<div id="chat-app">
  <aside id="sidebar">
    <div class="sidebar-header">
      <h2>Chats</h2>
    </div>
    <div id="conversation-list"></div>
  </aside>

  <main id="chat-main">
    <header id="chat-header">
      <div>
        <div id="chat-title">Select a conversation</div>
        <div id="chat-subtitle"></div>
      </div>
      <div id="chat-presence"></div>
    </header>

    <section id="messages"></section>

    <footer id="chat-footer">
      <div id="typing-indicator" style="display:none;">Someone is typing...</div>
      <div id="input-row">
        <input type="file" id="file-input" style="display:none;">
        <button id="attach-btn" title="Attach file">ðŸ“Ž</button>
        <input id="message-input" placeholder="Type a message" autocomplete="off">
        <button id="send-btn">Send</button>
      </div>
    </footer>
  </main>
</div>

<!-- Popup notifications container -->
<div id="chat-popup-container"></div>
<script>
window.CURRENT_USER = <?php echo (int)$currentUserId; ?>;
window.API_TOKEN = <?php echo json_encode($apiToken); ?>;
//window.WS_URL = "ws://localhost:8080/";
window.API_BASE = "api"; // api folder under exotic_vendor/

// Ask notification permission early
if (typeof Notification !== "undefined" && Notification.permission !== "granted") {
    Notification.requestPermission();
}

window.WS_URL =
    (location.protocol === 'https:' ? 'wss://' : 'ws://') +
    location.hostname +
    ':8080/?token=' + encodeURIComponent(window.API_TOKEN);
console.log("URL: " + window.WS_URL + " Current User: " + window.CURRENT_USER);
</script>
<script src="assets/chat.js"></script>
<div id="chat-popup-container"></div>
</body>
</html>
